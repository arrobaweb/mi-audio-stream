<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super O√≠do 6.2 (Debug)</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; text-align: center; 
            background-color: #000; color: #fff; /* Fondo negro puro para contraste */
            padding: 15px; margin: 0; user-select: none; padding-bottom: 50px;
        }
        h1 { color: #00ff00; margin: 5px 0; font-size: 20px; }

        /* ZONA DE DIAGN√ìSTICO */
        .debug-zone {
            background: #222; border: 1px solid #444; padding: 10px;
            margin-bottom: 15px; border-radius: 8px; font-family: monospace;
        }
        .led-container {
            display: flex; align-items: center; justify-content: center; gap: 15px;
            font-size: 14px; font-weight: bold;
        }
        .led {
            width: 20px; height: 20px; border-radius: 50%;
            background-color: #333; border: 2px solid #555;
        }
        .led.active { background-color: #ff0000; box-shadow: 0 0 20px #ff0000; border-color: #fff;}
        
        #dbValue { color: #ffeb3b; font-size: 1.2em; }

        /* EL RESTO IGUAL */
        .preset-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .preset-btn { background: #333; border: 1px solid #444; color: #aaa; padding: 10px; border-radius: 10px; cursor: pointer; }
        .preset-btn.active { background: #00d2ff; color: #000; font-weight: bold; }

        #btnPower {
            width: 90px; height: 90px; border-radius: 50%; border: 3px solid #333;
            background: #1e1e1e; color: #555; font-weight: bold; cursor: pointer;
            margin: 10px auto; display: flex; align-items: center; justify-content: center;
        }
        #btnPower.on { background: #00d2ff; color: #000; box-shadow: 0 0 25px #00d2ff; }

        .panel { background: #1a1a1a; border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        input[type=range] { width: 100%; margin-bottom: 10px; }
        .label-group { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom:5px;}
        .label-val { color: #00d2ff; }
    </style>
</head>
<body>

    <h1>Super O√≠do 6.2</h1>
    <div style="color: #666; font-size: 10px;">Modo Alta Sensibilidad</div>

    <div class="debug-zone">
        <div class="led-container">
            <div class="led" id="compLed"></div>
            <span>Reducci√≥n: <span id="dbValue">0.00</span> dB</span>
        </div>
        <div style="font-size: 10px; color: #aaa; margin-top:5px;">
            Si el n√∫mero cambia, funciona.
        </div>
    </div>

    <div class="preset-container">
        <button class="preset-btn active" onclick="loadPreset('general')">General</button>
        <button class="preset-btn" onclick="loadPreset('voz')">üó£Ô∏è Voz</button>
    </div>

    <div id="btnPower">OFF</div>

    <div class="panel">
        <div class="label-group"><span>VOLUMEN (Subir para activar LED)</span><span class="label-val" id="volVal">1.0x</span></div>
        <input type="range" id="volControl" min="1" max="30" step="0.5" value="1">
        
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <span style="font-size:0.9rem;">üõ°Ô∏è Compresor</span>
            <input type="checkbox" id="chkCompressor" checked>
        </div>
    </div>

    <div class="panel">
        <div class="label-group"><span>Bajos</span><span class="label-val" id="bassVal">0 dB</span></div>
        <input type="range" id="bassControl" min="-20" max="20" step="1" value="0">
        <div class="label-group"><span>Medios</span><span class="label-val" id="midVal">0 dB</span></div>
        <input type="range" id="midControl" min="-20" max="20" step="1" value="0">
        <div class="label-group"><span>Agudos</span><span class="label-val" id="trebleVal">0 dB</span></div>
        <input type="range" id="trebleControl" min="-20" max="20" step="1" value="0">
    </div>

    <script>
        let ctx, source, gainNode;
        let bassFilter, midFilter, trebleFilter;
        let compressorNode;
        let isOn = false;
        let animationId;

        const silentAudio = new Audio("data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABmYWN0BAAAAAAAAABkYXRhAAAAAA==");
        silentAudio.loop = true;

        const PRESETS = {
            'general': { vol: 15, bass: 0, mid: 0, treble: 0 }, // Volumen alto por defecto para probar
            'voz':     { vol: 20, bass: -10, mid: 5, treble: 0 }
        };

        const btn = document.getElementById('btnPower');
        const chkCompressor = document.getElementById('chkCompressor');
        const compLed = document.getElementById('compLed');
        const dbValue = document.getElementById('dbValue');

        const ui = {
            vol: { input: document.getElementById('volControl'), label: document.getElementById('volVal') },
            bass: { input: document.getElementById('bassControl'), label: document.getElementById('bassVal') },
            mid: { input: document.getElementById('midControl'), label: document.getElementById('midVal') },
            treble: { input: document.getElementById('trebleControl'), label: document.getElementById('trebleVal') }
        };

        function loadPreset(name) {
            const p = PRESETS[name];
            if (p) {
                ui.vol.input.value = p.vol; ui.bass.input.value = p.bass;
                ui.mid.input.value = p.mid; ui.treble.input.value = p.treble;
                updateAudioSystem();
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            }
        }

        btn.addEventListener('click', async () => {
            if (!isOn) {
                try {
                    silentAudio.play();
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    ctx = new AudioContext({ latencyHint: 'interactive' });
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });

                    source = ctx.createMediaStreamSource(stream);
                    gainNode = ctx.createGain();
                    
                    bassFilter = ctx.createBiquadFilter(); bassFilter.type = "lowshelf"; bassFilter.frequency.value = 250; 
                    midFilter = ctx.createBiquadFilter(); midFilter.type = "peaking"; midFilter.frequency.value = 1500; midFilter.Q.value = 1;
                    trebleFilter = ctx.createBiquadFilter(); trebleFilter.type = "highshelf"; trebleFilter.frequency.value = 3000;

                    // CONFIGURACI√ìN EXTREMA DEL COMPRESOR
                    compressorNode = ctx.createDynamicsCompressor();
                    compressorNode.threshold.value = -60; // ¬°Saltar√° con cualquier cosa!
                    compressorNode.knee.value = 0;        // Corte duro
                    compressorNode.ratio.value = 20;      // Aplastar sonido
                    compressorNode.attack.value = 0.001; 
                    compressorNode.release.value = 0.2;

                    // Source -> EQ -> Volumen -> Compresor -> Salida
                    source.connect(bassFilter);
                    bassFilter.connect(midFilter);
                    midFilter.connect(trebleFilter);
                    trebleFilter.connect(gainNode);
                    
                    connectChain();
                    updateAudioSystem();
                    monitorCompression();

                    isOn = true;
                    btn.innerText = "ON";
                    btn.classList.add('on');
                } catch (e) { alert("Error: " + e.message); }
            } else {
                if (ctx) ctx.close();
                silentAudio.pause();
                cancelAnimationFrame(animationId);
                compLed.classList.remove('active');
                isOn = false;
                btn.innerText = "OFF";
                btn.classList.remove('on');
            }
        });

        function connectChain() {
            if(!ctx) return;
            gainNode.disconnect();
            compressorNode.disconnect();
            
            if (chkCompressor.checked) {
                gainNode.connect(compressorNode);
                compressorNode.connect(ctx.destination);
            } else {
                gainNode.connect(ctx.destination);
            }
        }

        chkCompressor.addEventListener('change', connectChain);

        // MONITOR ULTRASENSIBLE
        function monitorCompression() {
            if (!isOn || !chkCompressor.checked) {
                 animationId = requestAnimationFrame(monitorCompression);
                 return;
            }

            // Obtener valor (intenta ambas formas por compatibilidad Android/iOS)
            let reduction = 0;
            if (typeof compressorNode.reduction === 'object') {
                reduction = compressorNode.reduction.value; // WebKit antiguo
            } else {
                reduction = compressorNode.reduction; // Est√°ndar moderno
            }

            // Mostrar el n√∫mero en pantalla (para que veas si se mueve)
            dbValue.innerText = reduction.toFixed(2);

            // Encender LED si baja aunque sea un poquito (-0.1 dB)
            if (reduction < -0.1) {
                compLed.classList.add('active');
            } else {
                compLed.classList.remove('active');
            }
            
            animationId = requestAnimationFrame(monitorCompression);
        }

        function updateAudioSystem() {
            ui.vol.label.innerText = ui.vol.input.value + "x";
            ui.bass.label.innerText = (ui.bass.input.value > 0 ? "+" : "") + ui.bass.input.value + " dB";
            ui.mid.label.innerText = (ui.mid.input.value > 0 ? "+" : "") + ui.mid.input.value + " dB";
            ui.treble.label.innerText = (ui.treble.input.value > 0 ? "+" : "") + ui.treble.input.value + " dB";

            if (isOn && gainNode) {
                gainNode.gain.value = ui.vol.input.value;
                bassFilter.gain.value = ui.bass.input.value;
                midFilter.gain.value = ui.mid.input.value;
                trebleFilter.gain.value = ui.treble.input.value;
            }
        }
        
        Object.values(ui).forEach(control => { control.input.addEventListener('input', updateAudioSystem); });
    </script>
</body>
</html>