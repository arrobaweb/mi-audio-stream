<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super O√≠do 17.0</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; text-align: center; 
            background-color: #000; color: #fff; 
            padding: 15px; margin: 0; user-select: none;
            padding-bottom: 80px; -webkit-tap-highlight-color: transparent;
        }
        h1 { color: #00ff00; margin: 10px 0; font-size: 18px; text-transform: uppercase; }

        /* --- VISUALIZADOR ULTRA SENSIBLE --- */
        .meter-wrapper {
            background: #111; border: 2px solid #333; border-radius: 8px;
            padding: 5px; margin-bottom: 20px;
        }
        .meter-container {
            width: 100%; height: 30px; 
            background: #000; overflow: hidden; position: relative;
            border-radius: 4px;
        }
        .meter-bar {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.05s linear; /* S√∫per r√°pido */
            box-shadow: 0 0 20px rgba(0,255,0,0.4);
        }
        #meterText { font-size: 12px; color: #888; margin-top: 5px; font-family: monospace; }

        /* CONTROLES */
        .main-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        #btnPower {
            width: 90px; height: 90px; border-radius: 50%; border: 4px solid #333;
            background: #111; color: #555; font-size: 16px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        #btnPower.on { 
            background: #00ff00; color: #000; border-color: #fff; 
            box-shadow: 0 0 40px #00ff00; transform: scale(1.05);
        }
        #btnRec {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid #333;
            background: #111; color: #cc0000; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        #btnRec.recording { background: #f00; color: #fff; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* CORTINA MODO BOLSILLO */
        #pocketCurtain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #btnPocket {
            background: #222; border: 1px solid #444; color: #aaa;
            padding: 15px; width: 100%; border-radius: 10px; margin-bottom: 20px; cursor: pointer;
        }

        /* PANELES */
        .panel { background: #1a1a1a; border-radius: 10px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; }
        input[type=range] { width: 100%; accent-color: #00ff00; margin-top:10px; }
        .labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; }
        .val { color: #00ff00; font-weight: bold; }

        /* PRESETS */
        .preset-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 20px; }
        .preset-btn { background: #111; border: 1px solid #333; color: #666; padding: 10px; border-radius: 5px; }
        .preset-btn.active { background: #00ff00; color: #000; font-weight: bold; }
    </style>
</head>
<body>

    <div id="pocketCurtain">
        <div style="font-size: 50px;">üîí</div>
        <div style="color: #666; margin-top: 20px;">Doble toque para desbloquear</div>
    </div>

    <h1>Super O√≠do 17.0</h1>

    <div class="meter-wrapper">
        <div class="meter-container">
            <div class="meter-bar" id="audioMeter"></div>
        </div>
        <div id="meterText">Nivel de Entrada: 0</div>
    </div>

    <div class="main-controls">
        <div id="btnPower">OFF</div>
        <div id="btnRec">‚óè</div>
    </div>

    <button id="btnPocket" onclick="enablePocketMode()">üåë MODO BOLSILLO</button>

    <div class="preset-container">
        <button class="preset-btn active" onclick="loadPreset('general')">Gral</button>
        <button class="preset-btn" onclick="loadPreset('voz')">Voz</button>
        <button class="preset-btn" onclick="loadPreset('cine')">Cine</button>
        <button class="preset-btn" onclick="loadPreset('calle')">Calle</button>
    </div>

    <div class="panel">
        <div class="labels"><span>Volumen</span><span class="val" id="volVal">1.0x</span></div>
        <input type="range" id="volControl" min="1" max="30" step="0.5" value="1">
        <div class="labels" style="margin-top:10px;"><span>Balance</span></div>
        <input type="range" id="balControl" min="-1" max="1" step="0.1" value="0">
    </div>

    <div class="panel">
        <div class="labels"><span>EQ (Bajos / Medios / Agudos)</span></div>
        <input type="range" id="bassControl" min="-20" max="20" step="1" value="0">
        <input type="range" id="midControl" min="-20" max="20" step="1" value="0">
        <input type="range" id="trebleControl" min="-20" max="20" step="1" value="0">
    </div>

    <label style="color:#666; font-size:12px;">
        <input type="checkbox" id="chkCompressor" checked> üõ°Ô∏è Compresor Activo
    </label>

    <script>
        let ctx, source, gainNode, pannerNode, analyser, compressor;
        let bassFilter, midFilter, trebleFilter;
        let mediaRecorder, destStream;
        let chunks = [];
        let isOn = false;
        let isRecording = false;
        let wakeLock = null;
        let animationId;

        // UI Elements
        const btn = document.getElementById('btnPower');
        const btnRec = document.getElementById('btnRec');
        const audioMeter = document.getElementById('audioMeter');
        const meterText = document.getElementById('meterText');
        const pocketCurtain = document.getElementById('pocketCurtain');
        const chkCompressor = document.getElementById('chkCompressor');

        const ui = {
            vol: document.getElementById('volControl'), volVal: document.getElementById('volVal'),
            bal: document.getElementById('balControl'),
            bass: document.getElementById('bassControl'), mid: document.getElementById('midControl'), treble: document.getElementById('trebleControl')
        };

        const PRESETS = {
            'general': { vol: 2, bass: 0, mid: 0, treble: -2 },
            'voz':     { vol: 5, bass: -12, mid: 8, treble: 2 },
            'cine':    { vol: 4, bass: 6, mid: 0, treble: 4 },
            'calle':   { vol: 6, bass: -15, mid: 5, treble: 5 }
        };

        // Cargar Memoria
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('superOido17_Settings');
            if (saved) {
                const config = JSON.parse(saved);
                applyConfig(config);
            }
        });

        btn.addEventListener('click', async () => {
            if (!isOn) {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    ctx = new AudioContext({ latencyHint: 'interactive' });
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });

                    source = ctx.createMediaStreamSource(stream);
                    
                    // --- ANALIZADOR (Conectado DIRECTO al Micr√≥fono) ---
                    analyser = ctx.createAnalyser();
                    analyser.fftSize = 256; 
                    source.connect(analyser); // Cable A: Visual

                    // --- AUDIO (Cable B: O√≠dos) ---
                    bassFilter = ctx.createBiquadFilter(); bassFilter.type = "lowshelf"; bassFilter.frequency.value = 250; 
                    midFilter = ctx.createBiquadFilter(); midFilter.type = "peaking"; midFilter.frequency.value = 1500; midFilter.Q.value = 1;
                    trebleFilter = ctx.createBiquadFilter(); trebleFilter.type = "highshelf"; trebleFilter.frequency.value = 3000;
                    pannerNode = ctx.createStereoPanner();
                    gainNode = ctx.createGain();
                    compressor = ctx.createDynamicsCompressor();
                    compressor.threshold.value = -30; compressor.ratio.value = 12;

                    destStream = ctx.createMediaStreamDestination();

                    // Cadena de Audio
                    source.connect(bassFilter);
                    bassFilter.connect(midFilter); midFilter.connect(trebleFilter);
                    trebleFilter.connect(pannerNode); pannerNode.connect(gainNode);
                    
                    updateChain(); // Compresor y Salida

                    updateValues();
                    drawMeter(); // Iniciar Loop Visual
                    
                    isOn = true;
                    btn.innerText = "ON"; btn.classList.add('on');
                    
                    // Activar WakeLock autom√°tico si es posible
                    try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}

                } catch (e) { alert("Error: " + e.message); }
            } else {
                stopAll();
            }
        });

        function updateChain() {
            if(!ctx) return;
            gainNode.disconnect(); compressor.disconnect();
            if(chkCompressor.checked) {
                gainNode.connect(compressor);
                compressor.connect(ctx.destination); compressor.connect(destStream);
            } else {
                gainNode.connect(ctx.destination); gainNode.connect(destStream);
            }
        }

        // --- MATEM√ÅTICA DE VOLUMEN (RMS) ---
        function drawMeter() {
            if(!isOn) return;
            animationId = requestAnimationFrame(drawMeter);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            // Usamos TimeDomain (Onda) en vez de Frecuencia para calcular volumen real
            analyser.getByteTimeDomainData(dataArray);

            let sum = 0;
            for(let i = 0; i < bufferLength; i++) {
                // Convertir de 0-255 a -1 a +1
                let x = (dataArray[i] - 128) / 128.0;
                sum += x * x;
            }
            // Ra√≠z cuadrada del promedio (RMS)
            let rms = Math.sqrt(sum / bufferLength);
            
            // Multiplicamos para que se vea bien (Sensibilidad)
            let volume = rms * 400; 
            if(volume > 100) volume = 100;
            if(volume < 0) volume = 0;

            // Debug Num√©rico
            meterText.innerText = "Nivel de Entrada: " + Math.round(volume);

            // Pintar Barra
            audioMeter.style.width = volume + "%";
        }

        function stopAll() {
            if(ctx) ctx.close();
            if(isRecording) stopRec();
            cancelAnimationFrame(animationId);
            if(wakeLock) wakeLock.release();
            isOn = false; btn.innerText = "OFF"; btn.classList.remove('on');
            audioMeter.style.width = "0%";
            meterText.innerText = "Nivel de Entrada: 0";
        }

        // --- PRESETS & UI ---
        function loadPreset(name) {
            const p = PRESETS[name];
            ui.vol.value = p.vol; ui.bass.value = p.bass; ui.mid.value = p.mid; ui.treble.value = p.treble;
            updateValues(); highlightButton(name); saveSettings(name);
        }
        function highlightButton(name) {
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            const map = {'general':0, 'voz':1, 'cine':2, 'calle':3};
            const btns = document.querySelectorAll('.preset-btn');
            if(btns[map[name]]) btns[map[name]].classList.add('active');
        }
        function updateValues() {
            ui.volVal.innerText = ui.vol.value + "x";
            if(!isOn) return;
            gainNode.gain.value = ui.vol.value; pannerNode.pan.value = ui.bal.value;
            bassFilter.gain.value = ui.bass.value; midFilter.gain.value = ui.mid.value; trebleFilter.gain.value = ui.treble.value;
        }
        function saveSettings(name) {
            const cfg = { vol: ui.vol.value, bal: ui.bal.value, bass: ui.bass.value, mid: ui.mid.value, treble: ui.treble.value, last: name || 'custom', comp: chkCompressor.checked };
            localStorage.setItem('superOido17_Settings', JSON.stringify(cfg));
        }
        function applyConfig(cfg) {
            ui.vol.value = cfg.vol; ui.bal.value = cfg.bal; ui.bass.value = cfg.bass; ui.mid.value = cfg.mid; ui.treble.value = cfg.treble;
            if(cfg.last) highlightButton(cfg.last);
            chkCompressor.checked = cfg.comp;
            updateValues();
        }

        [ui.vol, ui.bal, ui.bass, ui.mid, ui.treble].forEach(el => el.addEventListener('input', () => { updateValues(); saveSettings(); highlightButton(null); }));
        chkCompressor.addEventListener('change', () => { updateChain(); saveSettings(); });

        // --- GRABADORA ---
        btnRec.addEventListener('click', () => {
            if(!isOn) return;
            if(!isRecording) {
                chunks = [];
                mediaRecorder = new MediaRecorder(destStream.stream);
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { 'type' : 'audio/webm; codecs=opus' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.style.display='none'; a.href=url;
                    const d = new Date(); a.download = `Audio_${d.getHours()}-${d.getMinutes()}.webm`; 
                    document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url);
                };
                mediaRecorder.start(); isRecording = true; btnRec.classList.add('recording');
            } else {
                if(mediaRecorder) mediaRecorder.stop();
                isRecording = false; btnRec.classList.remove('recording');
            }
        });

        // --- MODO BOLSILLO ---
        let lastTap = 0;
        function enablePocketMode() {
            if(!isOn) return alert("Enciende primero el audio.");
            pocketCurtain.style.display = 'flex';
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(()=>{});
        }
        pocketCurtain.addEventListener('click', () => {
            const now = new Date().getTime();
            if (now - lastTap < 500) { pocketCurtain.style.display = 'none'; if (document.exitFullscreen) document.exitFullscreen().catch(()=>{}); }
            lastTap = now;
        });

    </script>
</body>
</html>