<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super O√≠do 8.1 Fix</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; text-align: center; 
            background-color: #050505; color: #e0e0e0; 
            padding: 10px; margin: 0; overscroll-behavior: none; user-select: none;
            padding-bottom: 80px;
        }
        h1 { 
            color: #00ffcc; margin: 5px 0; font-size: 18px; 
            text-transform: uppercase; letter-spacing: 2px;
        }

        /* --- VISUALIZADOR (CANVAS) --- */
        .viz-container {
            width: 100%; height: 80px; background: #000;
            border: 1px solid #333; margin-bottom: 10px;
            border-radius: 8px; overflow: hidden;
            position: relative;
        }
        canvas {
            width: 100%; height: 100%; display: block;
        }

        /* --- LED INDICATOR --- */
        .led-container {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 15px; font-size: 10px; color: #555; font-weight: 600; text-transform: uppercase;
        }
        .led {
            width: 10px; height: 10px; border-radius: 50%;
            background-color: #222; border: 1px solid #444; transition: all 0.1s;
        }
        .led.active { background-color: #ff3333; box-shadow: 0 0 10px #ff0000; border-color: #fff;}

        /* --- CONTROLES PRINCIPALES --- */
        .main-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }

        #btnPower {
            width: 80px; height: 80px; border-radius: 50%; border: 3px solid #2a2a2a;
            background: #181818; color: #444; font-size: 14px; font-weight: bold; cursor: pointer;
            box-shadow: inset 0 0 20px #000; display: flex; align-items: center; justify-content: center;
        }
        #btnPower.on { background: #00ffcc; color: #000; border-color: #fff; box-shadow: 0 0 30px #00ffcc; }

        #btnRec {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid #333;
            background: #181818; color: #cc0000; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        #btnRec.recording { background: #cc0000; color: #fff; animation: pulse 1s infinite; border-color: #fff;}
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- BOTONERA --- */
        .preset-container { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-bottom: 15px; }
        .preset-btn { background: #1e1e1e; border: 1px solid #333; color: #888; padding: 8px; border-radius: 8px; font-size: 11px; cursor: pointer; }
        .preset-btn.active { background: #00ffcc; color: #000; font-weight: bold; border-color: #fff;}

        /* --- PANELES --- */
        .panel { background: #161616; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #222; }
        .label-group { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; color: #888;}
        .label-val { color: #00ffcc; font-weight: bold; font-family: monospace;}

        input[type=range] { width: 100%; height: 5px; border-radius: 5px; background: #333; outline: none; -webkit-appearance: none; margin-bottom: 5px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #00ffcc; cursor: pointer; border: 2px solid #000; }
        
        .footer-opts { font-size: 10px; color: #555; display: flex; justify-content: space-around; margin-top: 10px;}
        input[type=checkbox] { accent-color: #00ffcc; }
    </style>
</head>
<body>

    <h1>Super O√≠do 8.1</h1>
    
    <div class="viz-container">
        <canvas id="visualizer"></canvas>
    </div>
    
    <div class="led-container">
        <div class="led" id="compLed"></div>
        <span id="recStatus">SISTEMA LISTO</span>
    </div>

    <div class="main-controls">
        <div id="btnPower">OFF</div>
        <div id="btnRec">‚óè</div>
    </div>
    
    <div class="preset-container">
        <button class="preset-btn active" onclick="loadPreset('general')">General</button>
        <button class="preset-btn" onclick="loadPreset('voz')">Voz</button>
        <button class="preset-btn" onclick="loadPreset('cine')">Cine</button>
        <button class="preset-btn" onclick="loadPreset('calle')">Calle</button>
    </div>

    <div class="panel">
        <div class="label-group"><span>VOLUMEN</span><span class="label-val" id="volVal">1.0x</span></div>
        <input type="range" id="volControl" min="1" max="30" step="0.5" value="1">
        
        <div class="label-group" style="margin-top: 15px;">
            <span>L</span><span style="color:#fff; font-size:10px;">BALANCE</span><span>R</span>
        </div>
        <input type="range" class="bal-slider" id="balControl" min="-1" max="1" step="0.1" value="0">
    </div>

    <div class="panel">
        <div class="label-group"><span>Bajos</span><span class="label-val" id="bassVal">0</span></div>
        <input type="range" class="bass-slider" id="bassControl" min="-20" max="20" step="1" value="0">
        <div class="label-group"><span>Medios</span><span class="label-val" id="midVal">0</span></div>
        <input type="range" class="mid-slider" id="midControl" min="-20" max="20" step="1" value="0">
        <div class="label-group"><span>Agudos</span><span class="label-val" id="trebleVal">0</span></div>
        <input type="range" class="treble-slider" id="trebleControl" min="-20" max="20" step="1" value="0">
    </div>

    <div class="footer-opts">
        <label><input type="checkbox" id="chkCompressor" checked> üõ°Ô∏è Compresor</label>
        <label><input type="checkbox" id="chkWakeLock"> üí° Pantalla ON</label>
    </div>

    <script>
        let ctx, source, gainNode, pannerNode, analyserNode, compressorNode;
        let bassFilter, midFilter, trebleFilter;
        let mediaRecorder, destStream;
        let chunks = [];
        let isOn = false;
        let isRecording = false;
        let wakeLock = null;
        let animationId;

        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');
        const container = document.querySelector('.viz-container');

        // Funci√≥n para ajustar el tama√±o del canvas al contenedor real
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        // Llamar una vez al inicio
        resizeCanvas();

        const silentAudio = new Audio("data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABmYWN0BAAAAAAAAABkYXRhAAAAAA==");
        silentAudio.loop = true;

        const PRESETS = {
            'general': { vol: 2, bass: 0, mid: 0, treble: -2 },
            'voz':     { vol: 5, bass: -12, mid: 8, treble: 2 },
            'cine':    { vol: 4, bass: 6, mid: 0, treble: 4 },
            'calle':   { vol: 6, bass: -15, mid: 5, treble: 5 }
        };

        const btn = document.getElementById('btnPower');
        const btnRec = document.getElementById('btnRec');
        const chkWakeLock = document.getElementById('chkWakeLock');
        const chkCompressor = document.getElementById('chkCompressor');
        const compLed = document.getElementById('compLed');
        const recStatus = document.getElementById('recStatus');

        const ui = {
            vol: { input: document.getElementById('volControl'), label: document.getElementById('volVal') },
            bal: { input: document.getElementById('balControl') },
            bass: { input: document.getElementById('bassControl'), label: document.getElementById('bassVal') },
            mid: { input: document.getElementById('midControl'), label: document.getElementById('midVal') },
            treble: { input: document.getElementById('trebleControl'), label: document.getElementById('trebleVal') }
        };

        window.addEventListener('load', () => {
            resizeCanvas(); // Asegurar tama√±o al cargar
            const saved = localStorage.getItem('superOido8_1_Settings');
            if (saved) {
                const config = JSON.parse(saved);
                applyConfigToUI(config);
                if(config.lastPreset) highlightButton(config.lastPreset);
                if(config.keepScreenOn) chkWakeLock.checked = true;
                if(config.compressor !== undefined) chkCompressor.checked = config.compressor;
            }
        });

        function loadPreset(name) {
            const p = PRESETS[name];
            if (p) {
                ui.vol.input.value = p.vol;
                ui.bass.input.value = p.bass;
                ui.mid.input.value = p.mid;
                ui.treble.input.value = p.treble;
                updateAudioSystem();
                highlightButton(name);
                saveToMemory(name);
            }
        }
        function highlightButton(name) {
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            const buttons = document.querySelectorAll('.preset-btn');
            const map = {'general':0, 'voz':1, 'cine':2, 'calle':3};
            if(buttons[map[name]]) buttons[map[name]].classList.add('active');
        }

        btn.addEventListener('click', async () => {
            if (!isOn) {
                try {
                    silentAudio.play();
                    
                    // CORRECCI√ìN VELOCIDAD: Quitamos 'sampleRate' forzado
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    ctx = new AudioContext({ latencyHint: 'interactive' }); 
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, latency: 0 }
                    });

                    source = ctx.createMediaStreamSource(stream);
                    
                    bassFilter = ctx.createBiquadFilter(); bassFilter.type = "lowshelf"; bassFilter.frequency.value = 250; 
                    midFilter = ctx.createBiquadFilter(); midFilter.type = "peaking"; midFilter.frequency.value = 1500; midFilter.Q.value = 1;
                    trebleFilter = ctx.createBiquadFilter(); trebleFilter.type = "highshelf"; trebleFilter.frequency.value = 3000;
                    
                    pannerNode = ctx.createStereoPanner();
                    gainNode = ctx.createGain();

                    compressorNode = ctx.createDynamicsCompressor();
                    compressorNode.threshold.value = -30; compressorNode.knee.value = 20; compressorNode.ratio.value = 12;
                    compressorNode.attack.value = 0.003; compressorNode.release.value = 0.25;

                    analyserNode = ctx.createAnalyser();
                    analyserNode.fftSize = 2048; // Calidad del gr√°fico

                    destStream = ctx.createMediaStreamDestination();

                    // CONEXI√ìN
                    source.connect(bassFilter);
                    bassFilter.connect(midFilter);
                    midFilter.connect(trebleFilter);
                    trebleFilter.connect(pannerNode); 
                    pannerNode.connect(gainNode);
                    
                    connectChain();

                    updateAudioSystem();
                    toggleWakeLock();
                    
                    // Reiniciar tama√±o del canvas por si acaso
                    resizeCanvas();
                    drawVisualizer(); 
                    monitorCompression();

                    isOn = true;
                    btn.innerText = "ON";
                    btn.classList.add('on');
                } catch (e) { alert("Error: " + e.message); }
            } else {
                stopAll();
            }
        });

        function stopAll() {
            if (ctx) ctx.close();
            if (isRecording) stopRecording();
            silentAudio.pause(); silentAudio.currentTime = 0;
            releaseWakeLock();
            cancelAnimationFrame(animationId);
            compLed.classList.remove('active');
            isOn = false;
            btn.innerText = "OFF";
            btn.classList.remove('on');
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function connectChain() {
            if(!ctx) return;
            gainNode.disconnect();
            compressorNode.disconnect();
            analyserNode.disconnect();

            let lastNode = gainNode;
            if (chkCompressor.checked) {
                lastNode.connect(compressorNode);
                lastNode = compressorNode;
            }
            lastNode.connect(analyserNode);
            analyserNode.connect(ctx.destination);
            analyserNode.connect(destStream);
        }

        btnRec.addEventListener('click', () => {
            if(!isOn) return alert("Enciende primero");
            if(!isRecording) {
                chunks = [];
                mediaRecorder = new MediaRecorder(destStream.stream);
                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { 'type' : 'audio/webm; codecs=opus' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const date = new Date();
                    a.download = `Audio_${date.getHours()}-${date.getMinutes()}-${date.getSeconds()}.webm`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    recStatus.innerText = "Guardado ‚úÖ";
                    setTimeout(() => recStatus.innerText = "SISTEMA LISTO", 3000);
                };
                mediaRecorder.start();
                isRecording = true;
                btnRec.innerText = "‚ñ†";
                btnRec.classList.add('recording');
                recStatus.innerText = "üî¥ GRABANDO...";
                recStatus.style.color = "#ff3333";
            } else {
                stopRecording();
            }
        });

        function stopRecording() {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            isRecording = false;
            btnRec.innerText = "‚óè";
            btnRec.classList.remove('recording');
            recStatus.innerText = "Procesando...";
            recStatus.style.color = "#555";
        }

        function drawVisualizer() {
            if(!isOn) return;
            animationId = requestAnimationFrame(drawVisualizer);

            const bufferLength = analyserNode.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyserNode.getByteTimeDomainData(dataArray);

            canvasCtx.fillStyle = '#000'; // Fondo negro limpio
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            canvasCtx.lineWidth = 3; // L√≠nea m√°s gruesa
            canvasCtx.strokeStyle = '#00ffcc'; // Color Neon
            canvasCtx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            for(let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2;

                if(i === 0) canvasCtx.moveTo(x, y);
                else canvasCtx.lineTo(x, y);

                x += sliceWidth;
            }
            canvasCtx.lineTo(canvas.width, canvas.height / 2);
            canvasCtx.stroke();
        }

        function monitorCompression() {
            if (!isOn || !chkCompressor.checked) return;
            let reduction = (typeof compressorNode.reduction === 'object') ? compressorNode.reduction.value : compressorNode.reduction;
            if (reduction <= -1.0) compLed.classList.add('active');
            else compLed.classList.remove('active');
            // Nota: el loop principal ya corre con requestAnimationFrame en drawVisualizer
        }

        function updateAudioSystem() {
            ui.vol.label.innerText = ui.vol.input.value + "x";
            ui.bass.label.innerText = (ui.bass.input.value > 0 ? "+" : "") + ui.bass.input.value;
            ui.mid.label.innerText = (ui.mid.input.value > 0 ? "+" : "") + ui.mid.input.value;
            ui.treble.label.innerText = (ui.treble.input.value > 0 ? "+" : "") + ui.treble.input.value;

            if (isOn && gainNode) {
                gainNode.gain.value = ui.vol.input.value;
                pannerNode.pan.value = ui.bal.input.value;
                bassFilter.gain.value = ui.bass.input.value;
                midFilter.gain.value = ui.mid.input.value;
                trebleFilter.gain.value = ui.treble.input.value;
            }
        }
        
        function saveToMemory(presetName) {
            const config = {
                vol: ui.vol.input.value,
                bass: ui.bass.input.value,
                mid: ui.mid.input.value,
                treble: ui.treble.input.value,
                lastPreset: presetName || 'custom',
                keepScreenOn: chkWakeLock.checked,
                compressor: chkCompressor.checked
            };
            localStorage.setItem('superOido8_1_Settings', JSON.stringify(config));
        }
        function applyConfigToUI(config) {
            ui.vol.input.value = config.vol;
            ui.bass.input.value = config.bass;
            ui.mid.input.value = config.mid;
            ui.treble.input.value = config.treble;
            updateAudioSystem();
        }

        chkCompressor.addEventListener('change', () => { connectChain(); saveToMemory(null); });
        Object.values(ui).forEach(control => { control.input.addEventListener('input', () => { updateAudioSystem(); saveToMemory(null); }); });
        
        async function toggleWakeLock() { if (chkWakeLock.checked && isOn) { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} } else { releaseWakeLock(); } }
        function releaseWakeLock() { if (wakeLock) { wakeLock.release(); wakeLock = null; } }
        chkWakeLock.addEventListener('change', () => { saveToMemory(null); toggleWakeLock(); });
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') toggleWakeLock(); });
    </script>
</body>
</html>