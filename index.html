<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super O√≠do 7.0 Premium</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            background-color: #121212; 
            color: #e0e0e0; 
            padding: 15px; 
            margin: 0; 
            overscroll-behavior: none; 
            user-select: none;
            padding-bottom: 60px;
        }
        h1 { 
            color: #00d2ff; margin: 10px 0 5px 0; 
            font-size: 22px; text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
        }

        /* --- LED INDICATOR (Protecci√≥n) --- */
        .led-container {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 20px; font-size: 11px; color: #555; font-weight: 600; text-transform: uppercase;
        }
        .led {
            width: 10px; height: 10px; border-radius: 50%;
            background-color: #222; border: 1px solid #444;
            transition: all 0.1s;
        }
        /* Cuando el compresor act√∫a: Rojo Intenso */
        .led.active { 
            background-color: #ff3333; 
            box-shadow: 0 0 10px #ff0000; 
            border-color: #fff;
        }

        /* --- BOTONERA PRESETS --- */
        .preset-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px;
        }
        .preset-btn {
            background: #1e1e1e; border: 1px solid #333; color: #888; padding: 12px;
            border-radius: 12px; font-size: 14px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .preset-btn.active {
            background: #00d2ff; color: #000; font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 210, 255, 0.3); border-color: #fff;
        }

        /* --- BOT√ìN POWER GIGANTE --- */
        #btnPower {
            width: 100px; height: 100px; 
            border-radius: 50%; border: 4px solid #2a2a2a;
            background: #181818; color: #444; 
            font-size: 16px; font-weight: bold; cursor: pointer;
            box-shadow: inset 0 0 20px #000;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 10px auto 30px auto;
            display: flex; align-items: center; justify-content: center;
        }
        #btnPower.on {
            background: #00d2ff; color: #000; border-color: #fff;
            box-shadow: 0 0 30px #00d2ff; transform: scale(1.05);
        }

        /* --- PANELES --- */
        .panel {
            background: #1e1e1e; border-radius: 15px; padding: 18px;
            margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .label-group { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: #999;}
        .label-val { color: #00d2ff; font-weight: bold; font-family: monospace;}

        /* --- SLIDERS PRO --- */
        input[type=range] {
            width: 100%; height: 6px; border-radius: 5px;
            background: #333; outline: none; -webkit-appearance: none; margin-bottom: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%;
            background: #00d2ff; cursor: pointer; box-shadow: 0 0 10px rgba(0,210,255,0.4); border: 2px solid #1e1e1e;
        }
        .bass-slider::-webkit-slider-thumb { background: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.4); }
        .mid-slider::-webkit-slider-thumb { background: #ffa502; box-shadow: 0 0 10px rgba(255, 165, 2, 0.4); }
        .treble-slider::-webkit-slider-thumb { background: #2ed573; box-shadow: 0 0 10px rgba(46, 213, 115, 0.4); }

        /* --- SWITCHES --- */
        .switch-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;
        }
        .switch-label { font-size: 0.9rem; color: #bbb; display: flex; align-items: center; gap: 8px;}
        input[type=checkbox] { width: 18px; height: 18px; accent-color: #00d2ff; cursor: pointer;}

    </style>
</head>
<body>

    <h1>Super O√≠do 7.0</h1>
    
    <div class="led-container">
        <div class="led" id="compLed"></div>
        <span id="compStatus">Protecci√≥n Auditiva</span>
    </div>
    
    <div class="preset-container">
        <button class="preset-btn active" onclick="loadPreset('general')">üéöÔ∏è General</button>
        <button class="preset-btn" onclick="loadPreset('voz')">üó£Ô∏è Voz</button>
        <button class="preset-btn" onclick="loadPreset('cine')">üé¨ Cine</button>
        <button class="preset-btn" onclick="loadPreset('calle')">üö¶ Calle</button>
    </div>

    <div id="btnPower">OFF</div>

    <div class="panel">
        <div class="label-group"><span>VOLUMEN MAESTRO</span><span class="label-val" id="volVal">1.0x</span></div>
        <input type="range" id="volControl" min="1" max="30" step="0.5" value="1">
        
        <div class="switch-row">
            <span class="switch-label">üõ°Ô∏è Compresor (Anti-Picos)</span>
            <input type="checkbox" id="chkCompressor" checked>
        </div>
    </div>

    <div class="panel">
        <div class="label-group"><span>Bajos (Cuerpo)</span><span class="label-val" id="bassVal">0 dB</span></div>
        <input type="range" class="bass-slider" id="bassControl" min="-20" max="20" step="1" value="0">
        
        <div class="label-group"><span>Medios (Voces)</span><span class="label-val" id="midVal">0 dB</span></div>
        <input type="range" class="mid-slider" id="midControl" min="-20" max="20" step="1" value="0">
        
        <div class="label-group"><span>Agudos (Brillo)</span><span class="label-val" id="trebleVal">0 dB</span></div>
        <input type="range" class="treble-slider" id="trebleControl" min="-20" max="20" step="1" value="0">
    </div>

    <div class="panel" style="padding: 12px;">
        <div class="switch-row" style="border:none; margin:0; padding:0;">
            <span class="switch-label">üí° Mantener pantalla activa</span>
            <input type="checkbox" id="chkWakeLock">
        </div>
    </div>

    <script>
        let ctx, source, gainNode;
        let bassFilter, midFilter, trebleFilter;
        let compressorNode;
        let isOn = false;
        let wakeLock = null;
        let animationId;

        // Audio fantasma para Background
        const silentAudio = new Audio("data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABmYWN0BAAAAAAAAABkYXRhAAAAAA==");
        silentAudio.loop = true;

        // --- PRESETS CALIBRADOS (Premium) ---
        const PRESETS = {
            'general': { vol: 2, bass: 0, mid: 0, treble: -2 }, // Agudos suaves
            'voz':     { vol: 5, bass: -12, mid: 8, treble: 2 },  // Corte de graves agresivo para claridad
            'cine':    { vol: 4, bass: 6, mid: 0, treble: 4 },    // Curva "V" moderada
            'calle':   { vol: 6, bass: -15, mid: 5, treble: 5 }   // Alerta m√°xima sin aturdir
        };

        const btn = document.getElementById('btnPower');
        const chkWakeLock = document.getElementById('chkWakeLock');
        const chkCompressor = document.getElementById('chkCompressor');
        const compLed = document.getElementById('compLed');
        const compStatus = document.getElementById('compStatus');

        const ui = {
            vol: { input: document.getElementById('volControl'), label: document.getElementById('volVal') },
            bass: { input: document.getElementById('bassControl'), label: document.getElementById('bassVal') },
            mid: { input: document.getElementById('midControl'), label: document.getElementById('midVal') },
            treble: { input: document.getElementById('trebleControl'), label: document.getElementById('trebleVal') }
        };

        // --- CARGAR MEMORIA ---
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('superOido7_Settings');
            if (saved) {
                const config = JSON.parse(saved);
                applyConfigToUI(config);
                if(config.lastPreset) highlightButton(config.lastPreset);
                if(config.keepScreenOn) chkWakeLock.checked = true;
                if(config.compressor !== undefined) chkCompressor.checked = config.compressor;
            }
        });

        // --- L√ìGICA DE PRESETS ---
        function loadPreset(name) {
            const p = PRESETS[name];
            if (p) {
                ui.vol.input.value = p.vol;
                ui.bass.input.value = p.bass;
                ui.mid.input.value = p.mid;
                ui.treble.input.value = p.treble;
                updateAudioSystem();
                highlightButton(name);
                saveToMemory(name);
            }
        }

        function highlightButton(name) {
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
            const buttons = document.querySelectorAll('.preset-btn');
            if(name === 'general') buttons[0].classList.add('active');
            if(name === 'voz') buttons[1].classList.add('active');
            if(name === 'cine') buttons[2].classList.add('active');
            if(name === 'calle') buttons[3].classList.add('active');
        }

        function saveToMemory(presetName) {
            const config = {
                vol: ui.vol.input.value,
                bass: ui.bass.input.value,
                mid: ui.mid.input.value,
                treble: ui.treble.input.value,
                lastPreset: presetName || 'custom',
                keepScreenOn: chkWakeLock.checked,
                compressor: chkCompressor.checked
            };
            localStorage.setItem('superOido7_Settings', JSON.stringify(config));
        }

        // --- MOTOR DE AUDIO ---
        btn.addEventListener('click', async () => {
            if (!isOn) {
                try {
                    silentAudio.play();
                    
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({ title: 'Super O√≠do 7.0', artist: 'Modo Premium Activo' });
                        navigator.mediaSession.setActionHandler('play', () => {}); 
                        navigator.mediaSession.setActionHandler('pause', () => {}); 
                    }

                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    ctx = new AudioContext({ latencyHint: 'interactive', sampleRate: 48000 });
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, latency: 0 }
                    });

                    source = ctx.createMediaStreamSource(stream);
                    gainNode = ctx.createGain(); // Volumen PRIMERO
                    
                    // Ecualizador
                    bassFilter = ctx.createBiquadFilter(); bassFilter.type = "lowshelf"; bassFilter.frequency.value = 250; 
                    midFilter = ctx.createBiquadFilter(); midFilter.type = "peaking"; midFilter.frequency.value = 1500; midFilter.Q.value = 1;
                    trebleFilter = ctx.createBiquadFilter(); trebleFilter.type = "highshelf"; trebleFilter.frequency.value = 3000;

                    // Compresor (Configuraci√≥n Equilibrada)
                    compressorNode = ctx.createDynamicsCompressor();
                    compressorNode.threshold.value = -30; // Sensible pero no exagerado
                    compressorNode.knee.value = 20;       // Curva suave
                    compressorNode.ratio.value = 12;      // Protecci√≥n fuerte
                    compressorNode.attack.value = 0.003;  // Reacci√≥n r√°pida
                    compressorNode.release.value = 0.25;  // Recuperaci√≥n natural

                    // CADENA: Source -> EQ -> VOLUMEN -> COMPRESOR -> OUT
                    source.connect(bassFilter);
                    bassFilter.connect(midFilter);
                    midFilter.connect(trebleFilter);
                    trebleFilter.connect(gainNode); // EQ entra al volumen
                    
                    connectChain(); // Volumen entra al Compresor o Salida

                    updateAudioSystem();
                    toggleWakeLock();
                    monitorCompression();

                    isOn = true;
                    btn.innerText = "ON";
                    btn.classList.add('on');
                } catch (e) { alert("Error: " + e.message); }
            } else {
                if (ctx) ctx.close();
                silentAudio.pause(); silentAudio.currentTime = 0;
                releaseWakeLock();
                cancelAnimationFrame(animationId);
                compLed.classList.remove('active');
                isOn = false;
                btn.innerText = "OFF";
                btn.classList.remove('on');
            }
        });

        function connectChain() {
            if(!ctx) return;
            gainNode.disconnect();
            compressorNode.disconnect();
            
            if (chkCompressor.checked) {
                gainNode.connect(compressorNode);
                compressorNode.connect(ctx.destination);
                compStatus.style.color = "#00d2ff"; // Azul
            } else {
                gainNode.connect(ctx.destination);
                compStatus.style.color = "#444"; // Apagado
                compLed.classList.remove('active');
            }
        }

        chkCompressor.addEventListener('change', () => { connectChain(); saveToMemory(null); });

        // --- MONITOR LED (Sin n√∫meros feos) ---
        function monitorCompression() {
            if (!isOn || !chkCompressor.checked) return;

            let reduction = 0;
            // Compatibilidad cruzada
            if (typeof compressorNode.reduction === 'object') {
                reduction = compressorNode.reduction.value; 
            } else {
                reduction = compressorNode.reduction; 
            }

            // Si reduce m√°s de 1dB, prender LED
            if (reduction <= -1.0) {
                compLed.classList.add('active');
            } else {
                compLed.classList.remove('active');
            }
            animationId = requestAnimationFrame(monitorCompression);
        }

        // --- HELPERS ---
        async function toggleWakeLock() {
            if (chkWakeLock.checked && isOn) { try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} } else { releaseWakeLock(); }
        }
        function releaseWakeLock() { if (wakeLock) { wakeLock.release(); wakeLock = null; } }
        chkWakeLock.addEventListener('change', () => { saveToMemory(null); toggleWakeLock(); });

        function updateAudioSystem() {
            ui.vol.label.innerText = ui.vol.input.value + "x";
            ui.bass.label.innerText = (ui.bass.input.value > 0 ? "+" : "") + ui.bass.input.value + " dB";
            ui.mid.label.innerText = (ui.mid.input.value > 0 ? "+" : "") + ui.mid.input.value + " dB";
            ui.treble.label.innerText = (ui.treble.input.value > 0 ? "+" : "") + ui.treble.input.value + " dB";

            if (isOn && gainNode) {
                gainNode.gain.value = ui.vol.input.value;
                bassFilter.gain.value = ui.bass.input.value;
                midFilter.gain.value = ui.mid.input.value;
                trebleFilter.gain.value = ui.treble.input.value;
            }
        }
        
        function applyConfigToUI(config) {
            ui.vol.input.value = config.vol;
            ui.bass.input.value = config.bass;
            ui.mid.input.value = config.mid;
            ui.treble.input.value = config.treble;
            updateAudioSystem();
        }

        Object.values(ui).forEach(control => { control.input.addEventListener('input', () => { updateAudioSystem(); document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active')); saveToMemory(null); }); });
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') toggleWakeLock(); });
    </script>
</body>
</html>